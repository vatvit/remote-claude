---
title: IP whitelist for incoming commands
status: completed
type: feature
priority: critical
epic: RCL-001
---

## Workflow

| # | Step | Status | Notes |
|---|------|--------|-------|
| 10 | Requirements | done | Already defined in description |
| 20 | Assessment | done | server.js reviewed |
| 30 | Architecture | done | Middleware + env var approach |
| 40 | Tests | skipped | Manual verification |
| 50 | Subtasks | skipped | Single implementation unit |
| 60 | Implementation | done | Middleware + env var, verified |
| 70 | Tech Debt | done | /api/respond is dead code |
| 80 | Reflection | done | Memory updated |

## Description

Implement IP whitelist filtering on the host server so that only requests from allowed IP addresses can send commands to Claude Code.

This is **mandatory** — the server must reject any incoming request to command/control endpoints (`POST /api/command` and potentially other sensitive endpoints) if the source IP is not in the configured whitelist.

### Requirements

- Configurable list of allowed IPs (e.g., via environment variable or config file)
- Reject requests from non-whitelisted IPs with 403 Forbidden
- Apply to all sensitive API endpoints (at minimum `POST /api/command`)
- Log rejected attempts (IP + timestamp)
- Support CIDR notation (e.g., `192.168.1.0/24`) — nice to have

## Implementation Notes

- **Config**: `ALLOWED_IPS` env var, comma-separated. Empty = allow all.
- **Middleware**: `ipWhitelist` applied to `POST /api/command`, `/api/respond`, `/api/reset`
- **CIDR**: Supported via bitwise subnet matching
- **IPv6-mapped**: Handles `::ffff:` prefix and `::1` → `127.0.0.1` normalization
- **Logging**: `[IP BLOCKED]` with IP, method, path, timestamp on stderr
- **Usage**: `ALLOWED_IPS="192.168.1.0/24,10.0.0.5" docker compose up`
