---
title: Chat UI improvements — bidirectional messages, interactive questions, history persistence
status: proposed
type: feature
priority: high
epic: remote-control
---

## Workflow

| # | Step | Status | Notes |
|---|------|--------|-------|
| 10 | Requirements | done | Defined below |
| 20 | Assessment | — | |
| 30 | Architecture | — | |
| 40 | Tests | — | |
| 50 | Subtasks | — | |
| 60 | Implementation | — | |
| 70 | Tech Debt | — | |
| 80 | Reflection | — | |

## Description

Improve the web chat UI to support full bidirectional communication with Claude, interactive question flows, and session-resilient history.

## Requirements

### 1. Bidirectional messages
- User → Claude: already works via `POST /api/command`
- Claude → User questions: detect when Claude is in `waiting_for_input` state
- Form should auto-switch between `sendCommand()` and `sendResponse()` based on state
- Bridge must set `waiting_for_input` state when Claude asks a question (currently defined but never set)

### 2. Multi-question with clickable option buttons
- Claude's `AskUserQuestion` tool sends questions via `tool_use` content blocks in stream-json
- **Show questions one at a time** (not tabs like terminal)
- Each question rendered as a card with:
  - Question text
  - Clickable option buttons (2-4 per question)
  - "Custom answer" text input option
- **Back/Forward navigation** between questions when multiple questions exist
- After last question answered → send all answers via `sendResponse()`
- Stream-json format: tool_use events arrive as `content_block_start` + `input_json_delta` chunks that need to be assembled

### 3. Loading animation
- Already implemented (typing indicator + working spinner)
- No changes needed

### 4. Chat state after refresh (in-memory)
- Server must also save assistant messages to `conversationHistory` (currently only saves user messages)
- Server.js needs to parse SSE events from bridge (currently raw byte pipe) to extract assistant content
- On page refresh, `loadHistory()` should show both user and assistant messages
- In-memory only — no disk persistence, lost on server restart

## Technical Notes

### Stream-JSON event format for questions
Claude CLI with `--output-format stream-json --verbose` outputs:
- `{"type":"system",...}` — init/hook events
- `{"type":"assistant","message":{"content":[...]},...}` — assistant messages with text and tool_use blocks
- `{"type":"result",...}` — final result with `result` text field

Tool use events for AskUserQuestion arrive as content blocks within assistant messages:
```json
{
  "type": "content_block_start",
  "content_block": {
    "type": "tool_use",
    "name": "AskUserQuestion",
    "input": {}
  }
}
```
Followed by `input_json_delta` chunks that build up the full input JSON containing questions array.

### Files to modify
- `web/app.js` — question rendering, back/forward navigation, state-aware form submission
- `web/style.css` — question card styles, option button styles, navigation buttons
- `web/index.html` — possibly add question container markup
- `host/server.js` — parse SSE events to capture assistant messages in history
- `bridge/bridge.py` — set `waiting_for_input` state when tool_use for AskUserQuestion detected

## User decisions
- Options UI: **Clickable buttons** (not numbered list)
- History persistence: **In-memory only** (survives page refresh, not server restart)
- Question flow: **One at a time** with back/forward navigation
